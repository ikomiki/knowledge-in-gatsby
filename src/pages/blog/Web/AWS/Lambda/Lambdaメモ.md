---
title: "Lambdaメモ"
templateKey: blog-post
date: 2020-07-15T17:08:00+09:00
tags: ["Lambda"]
draft: false
---

AWS Lambda のベストプラクティスを列挙します。

<!--more-->

## ベストプラクティス

- Lambda ハンドラーとコアロジックは分離する。(ユニットテストのため)
- SDK クライアントやデータベースの初期化は関数ハンドラーの外部で行う。（実行コンテキストの再利用）
- 静的アセットをローカルの`/tmp`ディレクトリにキャッシュする。（実行コンテキストの再利用）
- 環境変数を使用して、捜査パラメータを関数に渡す
- ランタイムの必要性に合わせて展開パッケージのサイズを最小かする
- (java)依存関係の.jar ファイルを別の/lib ディレクトリに置く。[Java の AWS Lambda デプロイパッケージ](https://docs.aws.amazon.com/lambda/latest/dg/java-package.html)参照
- 起動時に素早く読み込まれる単純なフレームワークを優先する。(例. Dagger > Guice、Spring Framework)
- Lambda 関数で再帰コードを使用しない。（自分自身の Lambda 関数を呼びださない）
- パフォーマンステストでメモリ設定を行う。（少しずつ調節し、変更しても性能が変わらない値が最適値）
- 最適なタイムアウト値を設定する。
- IAM ポリシーは最も制限の厳しいアクセス許可を使用する
- AWS Lambda の制限(limits)に精通する。ペイロードサイズ、ファイル記述し、 `/tmp`スペース。
- SQS 使用時は、関数の予想実行時間の値がキューの Visibility Timeout 値を超えていないことを確認する（関数の作成プロセスに失敗したり、呼び出し重複が起きたりする）
- 正常性を追跡するために、Lambda 関数メトリクスと CloudWatch アラームを使用する。
- 異なるバッチおよびレコードサイズでテストして、書くイベントソースのポーリング頻度が、関数がタスクを完了することができる速さに調節されるようにする。
- 同時実行するようにする。（Kinesis のシャードを追加する。）

See also: [AWS Lambda 関数を使用するためのベストプラクティス\-AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html)

## Lmabda の非同期処理

- 処理結果を松ことなく、他の処理を行うことができる（処理する時間の違いを吸収できる）
- バッファリングする（さもなければドロップ（処理が失われる）の可能性がある）
  - 遅延を補う方法がない
  - システム全体に伝播し回復緑芽さらに低下
  - 損失を回避することが重要
- トラフィックの急増、エラー処理に対する回復力

トレードオフ

- どれだけの着信トラフィックを処理でいるか
- 待ち時間、タイムアウトはどの程度か
- 未処理の扱いが重要

方法

- SQS イベントソース
- ストリームイベントソース
- 非同期呼び出し
