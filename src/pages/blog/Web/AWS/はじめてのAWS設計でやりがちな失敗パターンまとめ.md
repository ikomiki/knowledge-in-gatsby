---
title: "はじめてのAWS設計でやりがちな失敗パターンまとめ"
templateKey: blog-post
date: 2020-07-16T17:46:00+09:00
tags: [AWS, EC2, VPC, "AWS Organizations"]
draft: false
---

[はじめての AWS 設計でやりがちな失敗パターンまとめ \#devio2020 \- YouTube](https://www.youtube.com/watch?v=wJPMV0QK57I&t=26s)

## 小さく試さない

クラウドでは小さく試すことを繰り返せることが大きなメリット。
見当に時間をかけても設計は洗練されていかないことを理解する。

<!--more-->

## クラウドで塩漬ける

保守切れ対応を避けるだけの目的でクラウド。

塩漬けにしたいシステムをクラウドに持って行っても何も解決しない。
以降の目的がそれしかないのであれば計画から見直すべき。

## 入り組んだ要件

壮大なピタゴラスイッチを解決する。

各種サービスを利用しようとしすぎて、問題発生時に切り分けや復旧ができない独自機能を開発する。
工数を欠けてようやく開発した機能が AWS サービスアップデートで不要になることも。

その開発が本当に必要ですか？
AWS サービスのアップデートに対応できるように部品にとどめた機能保管を見当

### 【セッションレポート】AWS の「隙間」を埋める隙間家具 OSS 開発【

[【セッションレポート】AWS の「隙間」を埋める隙間家具 OSS 開発【\#AWSDevDay】 \| Developers\.IO](https://dev.classmethod.jp/articles/aws-devday-tokyo-2019-furniture-oss/)

AWS のマネージドサービスで、工夫でなんとかなる機能（例:タイムゾーン）、他サービスとの連携便利機能(例:Log 出力)は後回しになりがち（← 隙間）

マネージドサービスは勝手に強くなる。
自前運用は勝手には強くならない

（人的コストを充分に払えないなら）多少不便でも（致命的でないなら）マネージドサービスを選択し後日の機能拡張を期待しつつ運用の手間を減らした方が良い

隙間家具を自作する。
小さく、そのユースケースで適切な汎用度を持った者を作る。本家が隙間を埋めたら捨てられる粒度で作る。

例えば、S3→Redshift への継続的に取り込む。 → [fujiwara/Rin](https://github.com/fujiwara/Rin)  
→Kinesis Firehose 発表により隙間が埋まる  
隙間埋め(Rin)自体はまだ生きている。 ELB/ALB のログが S3 に配置するものを菊時取り込むのに活躍中

CloudSearch でデータを継続的に取り込む。[fujiwara/s32cs](https://github.com/fujiwara/s32cs) S3 のイベントトリガ利用。

SSM Parameter Store の値を環境へ数に設定してコマンドを exec する Wrapper [handlename/ssmwrap: Exec command with environment variables loaded from AWS SSM\.](https://github.com/handlename/ssmwrap/)
→ ECS task に SSM パラメータストアの値を環境変数として設定できる secrets 機能リリース（ssmwrap 自体は ECS 以外で使える。EC2 や CircleCI でも)

OSS として作る

自分らしか使わなくても OSS にしてしまう

- ドキュメントを書く気になる
- 過度な社内事情の混入を防ぐ
- 魔改造番が増殖するのを防ぐ
- 同じような隙間家具をみんなが毎回手書きするのは無駄!

## 複数サブシステム

AWS アカウント分割の方針を決めずに、AWS アカウントを増やし続けたり、逆に一つの AWS アカウントに複数システムを混在させてしまう。
AWS アカウントおよびネットワーク設計は、あとから変更するコストが大きいため、当初の方針のママ運用を進めるしかない。

分割設計は事前に検討する。
サブシステム、本番／テスト、セキュリティなどの観点で要件を整理する。

### AWS 複数アカウントの構成基準を考えてみる

[AWS 複数アカウントの構成基準を考えてみる \| Developers\.IO](https://dev.classmethod.jp/articles/mutil-aws-account-strategy/)

#### 使い分けのパターン

- 環境（本場、開発、ステージング）
- 請求
- 管制塔（一括請求のマスターアカウント、マネジメントコンソールログイン用、統制）
- 共有 VPC
- 同じリソース名を使いたい

##### 管制塔 - マネジメントコンソールログイン用

IAM ユーザを作成するのは管制塔アカウントのみにする。他のアカウントにはスイッチロールでログインする。
IAM ユーザを極量作らないようにして、パスワード漏洩のリスクを低減する。

##### 管制塔 - 統制

CloudTrail や Config を管制塔アカウントに集約し、アカウント統制に活用する。
他にもアクセスログを集約する、EC2 のインベントリ情報を集約する。

##### 共有 VPC

Organizations でリソース共有を有効化すると、複数アカウントで共有された VPC を作成できる。同じ組織二属する他のアカウントと一つまたは複数のサブネットを共有する。

VPC 単位でかかっていた費用を削減することが可能。（NAT ゲートウェイ、仮想プライベートゲートウェイ、PrivateLink、VPC Peering など）

機能面、設計面（主に自由度）で制限があるので充分に検討。

##### AWS Organizations

複数の AWS アカウントをポリシーベースで一元管理する。

[20180214 AWS Black Belt Online Seminar AWS Organizations](https://www.slideshare.net/AmazonWebServicesJapan/20180214-aws-blackbeltorganizations)

## IP アドレスを静的に管理しようとする

プライベート IP に依存した作りにすることで、再構築の手間がかかる。
VPC 内に構築されるマネージドサービス(ELB,RDS など)が利用する IP アドレスを考慮が漏れ、IP が枯渇する

可能な限り動的管理に任せて DNS を利用する。
マネージドサービスが消費する IP アドレスを考慮し、余裕を持ってサブネットを定義する。

### Amazon VPC 設計時に気をつけたい基本の 5 のこと

[Amazon VPC 設計時に気をつけたい基本の 5 のこと \| Developers\.IO](https://dev.classmethod.jp/articles/amazon-vpc-5-tips/)

#### RFC1918 準拠の IP アドレスの範囲から指定する

- 10.0.0.0 - 10.255.255.255 (10/8 プレフィックス)
- 172.16.0.0 - 172.31.255.255 (172.16/12 プレフィックス)
- 192.168.0.0 - 192.168.255.255 (192.168/16 プレフィックス)

#### 拡張に対応できる IP アドレス範囲を指定する

- デフォルトで*3*アドレスが予約。ネットワークアドレス、ブロードキャストも割り当て不可のため、*5*個のアドレスがデフォルトで使用。
- ELB _8 以上_
- Auto Scailing _EC2 インスタンスの最大値分_
- VPC PrivateLink _エンドポイント毎に 1_
- ECS/EKS _ENI 分_
- Lambda _必要な ENV 分_。 ENI = 「関数がサポートする必要がある自動実行の数」 \* (メモリ容量(GB) / 3GB)

#### Direct Connect、VPN、VPC Peering 利用時には IP アドレス範囲の重複に注意する

#### ブロードキャストとマルチキャストは使えない

#### サブネットの設計例

- パブリック : インターネットゲートウェイ経由で外部と通信できるサブネット
- プライベート : NAT ゲートウェイ経由で外部への通信ができるサブネット
- アイソレート : 外部との通信ができないサブネット

## 閉域網

目的不明のママ閉域網構成にする。

オンプレミス環境での設計の延長から、閉域ネットワーク(Direct Connect や Site-to-Site VPNn など)としたが、明確なポリシーがあるわけではない

逆に新たに高知楠田環境が閉域ネットワーク内にある他の重要システムへのアクセス経路となってしまうことで意図せぬ脅威にさらされるパターンも

### バーストパフォーマンスインスタンス

コスト判断でバースト系ファミリー(T2,T3 など)を選択する
クレジット枯渇すると一気にベースラインまでパフォーマンスが落ちるため、システム不可に二なるケースも。

一般公開する本番サービスでは使わない。
コストパフォーマンスに優れる A1(RM ベース)ファミリーも検討。

#### ちょっと待ってください\!あなたが使うべきは本当に T 系インスタンスですか\!?

以下の条件全てに当てはまるなら､最初から T 系インスタンスは使わないでください!

- 初めて AWS を使う
- 本番環境である
- 一般公開するシステムである(社内向けシステムではない)

[ちょっと待ってください\!あなたが使うべきは本当に T 系インスタンスですか\!? \| Developers\.IO](https://dev.classmethod.jp/articles/ec2-t-or-m/)

### ディスクサイズ

ディスクサイズを多めに検討しがち

実態調査をせずに、オンプレト同じ感覚で大きなディスクサイズを割り当ててしまい、ランニングコストが想定以上になってしまう。
バックアップデータをローカルにため込むような設計になっている。

EBS は動的に拡張可能なので、監視閾値を調節しつつ、後から変更する。[OS 別 EBS オンライン拡張方法 \| Developers\.IO](https://dev.classmethod.jp/articles/expand-ebs-in-online/)
バックアップデータは、安価で堅牢な S3 などに定期的に逃すように。

### スペック選定

性能のでない低スペックのマシンからバッチ処理の検証をスタートしたため、処理に時間がかかりすぎてしまう。
事前に検討していたコスト見積もりを節約しすぎたために、クラウドの柔軟性を生かすことが出来ない。

検証時にけちりすぎない。一次的に大きく作って削除できるのもクラウドのメリット。

### テスト環境構成

本番とテストで構成が違う

テスト環境は可能な限り本番と同じ構成に。
不要時の停止やスペック調整でコストコントロールする。

### バックアップ

そもそもバックアップを取得していない

最低限のバックアップやログを取得しておく

- [SingleAZ 配置の EC2 インスタンスで障害発生時の影響を最小化する \| Developers\.IO](https://dev.classmethod.jp/articles/minimize-failure-impact-on-singleaz/)
- [【新サービス】 AWS の各種サービスのバックアップを管理する AWS Backup が登場！ ｜ DevelopersIO](https://dev.classmethod.jp/cloud/aws/aws-backup/)
- [AWS 運用かんたん自動化ツール opswitch（オプスウィッチ） by クラスメソッド](https://opswitch.io/)
- [EC2 インスタンスをインスタンス ID を変えずに復元する](https://dev.classmethod.jp/writing/ec2_instanceid_same_id/)

### 組織

クラウド推進担当におまかせ状態になる

特定の担当に頼りすぎず、全社でクラウドの理解を浸透させるための活動も変更して行う。

組織がベンダー選定やシステム評価ができない状態ではクラウドのメリットが享受できない。
